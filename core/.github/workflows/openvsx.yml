name: Publish to Open VSX

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  publish:
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            binary: eisen-core
          - os: macos-latest
            target: darwin-arm64
            binary: eisen-core
          - os: macos-latest
            target: darwin-x64
            binary: eisen-core
            rust-target: x86_64-apple-darwin
          - os: windows-latest
            target: win32-x64
            binary: eisen-core.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target || '' }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core -> target

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set extension version from tag
        shell: bash
        run: |
          VERSION="${{ github.event.workflow_run.head_branch }}"
          VERSION="${VERSION#v}"
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('extension/package.json', 'utf8'));
            pkg.version = process.argv[1];
            fs.writeFileSync('extension/package.json', JSON.stringify(pkg, null, 2) + '\n');
          " "$VERSION"
          echo "Publishing context-eisen v${VERSION} (${{ matrix.target }}) to Open VSX"

      - name: Install Node dependencies
        shell: bash
        run: |
          cd ui && pnpm install
          cd ../extension && pnpm install

      - name: Build Rust binary
        run: cargo build --release --manifest-path core/Cargo.toml ${{ matrix.rust-target && format('--target {0}', matrix.rust-target) || '' }}

      - name: Copy binary into extension
        shell: bash
        run: |
          mkdir -p extension/bin
          if [ -n "${{ matrix.rust-target }}" ]; then
            cp "core/target/${{ matrix.rust-target }}/release/${{ matrix.binary }}" "extension/bin/${{ matrix.binary }}"
          else
            cp "core/target/release/${{ matrix.binary }}" "extension/bin/${{ matrix.binary }}"
          fi
          chmod +x "extension/bin/${{ matrix.binary }}" 2>/dev/null || true

      - name: Build UI
        shell: bash
        run: pnpm build
        working-directory: ui

      - name: Build Extension
        shell: bash
        run: pnpm build
        working-directory: extension

      - name: Package platform-specific VSIX
        shell: bash
        run: npx @vscode/vsce package --no-dependencies --target ${{ matrix.target }}
        working-directory: extension

      - name: Publish to Open VSX
        shell: bash
        env:
          VSX_API_KEY: ${{ secrets.VSX_API_KEY }}
        run: npx ovsx publish extension/*.vsix -p "$VSX_API_KEY"
